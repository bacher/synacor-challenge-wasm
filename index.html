<!doctype html>
<html lang="en">
  <head>
    <title>Synacor challenge in WASM</title>
    <script type="module">
      import { instantiate } from './build/debug.js';

      const NEW_LINE_CHAR_CODE = '\n'.charCodeAt(0);

      const url = new URL('build/debug.wasm', import.meta.url);

      const module = await WebAssembly.compileStreaming(globalThis.fetch(url));

      let message = undefined;

      const outputCharBuffer = [];

      const inputLines = ['help', 'look tablet', 'take tablet', 'inv', 'look'];
      let inputIndex = 0;
      let inputBuffer = '';

      export const { memory, readMemory, putUserInput, run } =
        await instantiate(module, {
          env: {
            outputChar: (value) => {
              if (value === NEW_LINE_CHAR_CODE) {
                if (outputCharBuffer.length) {
                  console.log(outputCharBuffer.join(''));
                  outputCharBuffer.length = 0;
                }
              } else {
                outputCharBuffer.push(String.fromCodePoint(value));
              }
            },
          },
        });

      function timeout(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }

      async function runApplication() {
        console.log('[RUN]');

        while (true) {
          const returnCode = run();

          switch (returnCode) {
            case 0:
              console.log('[HALT]');
              return;
            case 1: {
              await timeout(0);

              const message = window.prompt('>')?.trim();
              if (!message) {
                console.log('[INTERRUPTED]');
                return;
              }

              await timeout(0);

              const charCodes = `${message}\n`
                .split('')
                .map((char) => char.charCodeAt(0));

              for (const code of charCodes) {
                if (code >= 128) {
                  throw new Error(`Invalid char code: (${code})`);
                }
              }

              putUserInput(charCodes);
              break;
            }
          }
        }
      }

      runApplication().catch((error) => {
        console.error(error);
      });
    </script>
  </head>
  <body></body>
</html>
